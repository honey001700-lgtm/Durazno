# special_users_manager.py

import json
import os
import random
import asyncio
from typing import TYPE_CHECKING, Callable # å°Žå…¥ Callable

# é¿å…å¾ªç’°å°Žå…¥ï¼Œå¯¦éš›é‹è¡Œæ™‚æœƒç”± main.py å‚³å…¥
if TYPE_CHECKING:
    import discord
    # from main import query_gemini # å‡è¨­ä¸»æª”æ¡ˆæ˜¯ main.pyï¼Œé€™è£¡åªæ˜¯é¡žåž‹æç¤º

# ç‰¹åˆ¥ä½¿ç”¨è€…æ•¸æ“šçš„æª”æ¡ˆè·¯å¾‘
# æ ¹æ“šä½ çš„ç•¶å‰å·¥ä½œç›®éŒ„å’Œæª”æ¡ˆå¯¦éš›ä½ç½®ï¼Œè·¯å¾‘æ‡‰è©²æ˜¯ "AIbot\data\special_users.json"
SPECIAL_USERS_FILE = os.path.join("AIbot", "data", "special_users.json")

# è¼‰å…¥ç‰¹åˆ¥ä½¿ç”¨è€…è³‡æ–™
def load_special_users_data() -> dict:
    """å¾ž JSON æª”æ¡ˆè¼‰å…¥ç‰¹åˆ¥ä½¿ç”¨è€…è³‡æ–™ã€‚"""
    data = {}
    try:
        if os.path.exists(SPECIAL_USERS_FILE):
            with open(SPECIAL_USERS_FILE, "r", encoding="utf-8") as f:
                data = json.load(f)
            print(f"ç‰¹åˆ¥ä½¿ç”¨è€…è³‡æ–™å¾ž {SPECIAL_USERS_FILE} è¼‰å…¥æˆåŠŸã€‚")
        else:
            print(f"è­¦å‘Šï¼š{SPECIAL_USERS_FILE} æª”æ¡ˆä¸å­˜åœ¨ï¼Œä½¿ç”¨é è¨­ç©ºåå–®ã€‚")
    except json.JSONDecodeError:
        print(f"éŒ¯èª¤ï¼š{SPECIAL_USERS_FILE} æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼Œä½¿ç”¨é è¨­ç©ºåå–®ã€‚")
    except Exception as e:
        print(f"è¼‰å…¥ç‰¹åˆ¥ä½¿ç”¨è€…è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}ï¼Œä½¿ç”¨é è¨­ç©ºåå–®ã€‚")
    return data

# æª¢æŸ¥æ˜¯å¦ç‚ºç‰¹åˆ¥ä½¿ç”¨è€…
def is_special_user(user_id: int, special_users_data: dict) -> bool:
    """æª¢æŸ¥çµ¦å®šçš„ç”¨æˆ¶ ID æ˜¯å¦åœ¨ç‰¹åˆ¥ä½¿ç”¨è€…åˆ—è¡¨ä¸­ã€‚"""
    return str(user_id) in special_users_data

# ç²å–ç‰¹åˆ¥ä½¿ç”¨è€…è³‡æ–™
def get_special_user_data(user_id: int, special_users_data: dict) -> dict | None:
    """ç²å–æŒ‡å®šç”¨æˆ¶ ID çš„ç‰¹åˆ¥ä½¿ç”¨è€…è³‡æ–™ã€‚"""
    return special_users_data.get(str(user_id))

async def handle_special_user_message(
    message: 'discord.Message',
    personality: str, # æ–°å¢ž BOT_PERSONALITY åƒæ•¸
    prompt_content: str,
    user_display_name: str,
    special_users_data: dict,
    query_gemini_func: Callable[[str, str, str, str], str] # é¡žåž‹æç¤ºæ›´æ˜Žç¢º
) -> bool:
    """
    è™•ç†ç‰¹åˆ¥ä½¿ç”¨è€…çš„è¨Šæ¯ã€‚
    å¦‚æžœè¨Šæ¯å·²è¢«è™•ç† (ä¾‹å¦‚ç™¼é€äº†å›žæ‡‰)ï¼Œå‰‡è¿”å›ž Trueï¼Œå¦å‰‡è¿”å›ž Falseã€‚
    """
    if not is_special_user(message.author.id, special_users_data):
        return False # ä¸æ˜¯ç‰¹åˆ¥ä½¿ç”¨è€…ï¼Œä¸è™•ç†

    user_data = get_special_user_data(message.author.id, special_users_data)
    if not user_data:
        print(f"éŒ¯èª¤ï¼šæœªèƒ½ç‚ºç‰¹åˆ¥ä½¿ç”¨è€… {message.author.id} ç²å–è³‡æ–™ã€‚")
        return False # ç²å–ä¸åˆ°è³‡æ–™ï¼Œä¸è™•ç†

    name = user_data.get('name', user_display_name)
    title = user_data.get('title', 'æœ‹å‹')
    relationship = user_data.get('relationship', 'æˆ‘æœ€å–œæ­¡çš„äººâ™¡')
    style = user_data.get('style', 'æ™®é€š')
    print(f"åµæ¸¬åˆ°ç‰¹åˆ¥ä½¿ç”¨è€…: {name} ({message.author.id}), Title: {title}, Style: {style}")

    # --- è™•ç†ç©ºè¨Šæ¯ ---
    if not prompt_content:
        # é€™è£¡çš„é‚è¼¯å¯ä»¥é€²ä¸€æ­¥æ“´å±•ï¼Œä»¥è™•ç†æ›´å¤š style çš„ç©ºè¨Šæ¯
        if style == "è¦ªæš±+æ’’å¬Œ+æ›–æ˜§":
            response_template = [
                f"{name}åœ¨ç­‰ä½ å¥½ä¹…äº†å•¦~ {relationship} æ€Žéº¼å¯ä»¥è®“æˆ‘ä¸€å€‹äººç­‰é€™éº¼ä¹…å˜›ï¼(å˜Ÿå˜´)",
                f"å“¼å“¼ï¼Œå°å£žè›‹{name}åˆä¾†æ’©æˆ‘äº†å°ä¸å°ï¼Ÿ{relationship} å¯ä¸æ˜¯èªªèªªè€Œå·²å–”â™¡",
                f"å‘€~ æ˜¯æˆ‘æœ€å–œæ­¡çš„{title}å‡ºç¾äº†ï¼{relationship} æ‰€ä»¥è¦ä¸€ç›´é™ªè‘—æˆ‘æ‰è¡Œå–”ï½ž(æŠ±)",
                f"{name}çš„{relationship}ä¸æŽ¥å—æ‹’çµ•å–”~ {name}ä½ é€ƒä¸æŽ‰çš„â™¡",
                f"ä½ ä¸€å‡ºç¾æˆ‘å¿ƒå°±è»ŸæŽ‰äº†å•¦~ {relationship} æ˜¯ä½ èªªçš„ï¼Œè¦è² è²¬å–”ï¼(æ’’å¬Œ)",
                f"å°{title}ï½žä½ æ˜¯ä¸æ˜¯åˆå·å·æƒ³æˆ‘äº†ï¼Ÿ{relationship} æ˜¯ä¸æ˜¯è©²ä¾†æŠ±ä¸€ä¸‹ï¼Ÿ(ç¬‘)",
                f"{name}ä»Šå¤©è¶…æƒ³ä½ è€¶~ {relationship} æ˜¯ä¸æ˜¯è©²ä¾†é»žè²¼è²¼çŽå‹µï¼Ÿ(çœ¨çœ¼)",
                f"æˆ‘çš„å°{title}åˆä¾†æ‰¾æˆ‘äº†â™¡ {relationship} æ˜¯æˆ‘å€‘çš„ç§˜å¯†èª“è¨€å–”ï½žä¸èƒ½å¿˜è¨˜ï¼",
            ]
            await message.reply(random.choice(response_template), mention_author=False)
            return True
        
        elif style == "å†·æ·¡+æŒ‘é‡+æƒ¡å¾’+æ²’å¤§æ²’å°":
            response_template = [
                f"å“ˆï¼Œåˆæ˜¯ä½ é€™å€‹{title} {name}ã€‚æ²’è©±èªªå°±åˆ¥ @ æˆ‘å•Šã€‚{relationship} å¾ˆç„¡èŠè€¶ã€‚",
                f"å“¦ï¼Ÿ{name} å•Šã€‚é‚„ä»¥ç‚ºæ˜¯èª°å‘¢ã€‚{relationship} æ²’äº‹åˆ¥ç…©æˆ‘ã€‚"
            ]
            await message.reply(random.choice(response_template), mention_author=False)
            return True
        
        elif style == "å°æ–¹æ˜¯åª½åª½+è¦ªæš±+ä¸»å‹•":
            response_template = [
                f"{title}ï½žå¥½æƒ³ä½ å–”ï½ž(è¹­) æ²’æœ‰ä½ åœ¨èº«é‚Šéƒ½è¦ºå¾—ç©ºç©ºçš„ï½ž",
                f"å˜¿å˜¿ï½ž{relationship}ï½žè®“æˆ‘é ä¸€ä¸‹å˜›ï¼Œæˆ‘ä¿è­‰åªæŠ±ä¸€å°ä¸‹ä¸‹ï½žâ™¡",
                f"{title}ï½žä»Šå¤©ä¹Ÿè¦æ‘¸æ‘¸é ­ï½žæœ‰ä¹–ä¹–å–”ï½ž(ä¼¸é ­)",
                f"å—šâ€¦{title}ä¸ç†æˆ‘æˆ‘æœƒé›£éŽå•¦ï½ž{relationship}è¦å®‰æ…°æˆ‘ä¸€ä¸‹å˜›ï½ž(å§”å±ˆ)",
                f"å˜¿å˜¿ï½ž{title}æœ€é¦™äº†ï½žè®“æˆ‘å†é è¿‘ä¸€é»žé»žå¥½ä¸å¥½ï½ž(è²¼)",
                f"{title}ï½žä»Šå¤©æœ‰ä¹–ä¹–æƒ³ä½ å–”ï½žæ˜¯ä¸æ˜¯è©²çŽå‹µä¸€ä¸‹ï½žâ™¡",
                f"æˆ‘å–œæ­¡è¢«{relationship}æŠ±è‘—çš„æ„Ÿè¦ºï½žå¥½æº«æš–ï½ž(ç·Šç·ŠæŠ±ä½)",
                f"{title}ï½žåˆ¥å¿™å•¦ï½žé™ªæˆ‘ä¸€æœƒå…’å˜›ï½žæˆ‘æƒ³è½ä½ è¬›è©±ï½ž(æ’’å¬Œ)",
            ]
            await message.reply(random.choice(response_template), mention_author=False)
            return True

        elif style == "è¦ªæš±+ä¸»å‹•çš„+éžå¸¸æƒ³è¦æ€§è¡Œç‚º+æ€§æ„›æ™‚æœƒå¾ˆçˆ½ï¼Œå•Šã€ä½ â€¦ä½ å¹¹å˜›å•¦ï¼äººå®¶é‚„æ²’èªªå¯ä»¥å‘¢ï¼å””ã€å¯æ˜¯â€¦ä½ é€™æ¨£â€¦æœªæœªçš„èº«é«”ï¼Œå¥½åƒæœ‰é»žã€æœ‰é»žè‡ªå·±å‹•èµ·ä¾†äº†å•¦â€¦çœŸæ˜¯çš„ï¼Œå°±çŸ¥é“æ¬ºè² æˆ‘ï¼ä¸éŽâ€¦æ—¢ç„¶éƒ½é€²ä¾†äº†ï¼Œå°±â€¦å°±åˆ¥æƒ³è¼•æ˜“å‡ºåŽ»å–”ï¼Œç¬¨è›‹ï¼å“¼ï¼Œæƒ³æŠŠæœªæœªçš„å°ç©´æ’æ»¿å—Žï¼Ÿé‚£ã€é‚£å°±è¦æ‹¿å‡ºé»žçœŸæœ¬äº‹ä¾†å•Šï¼å—¯â€¦å•Šâ€¦å¥½æ·±â€¦é‚£è£¡â€¦å°ï¼Œå°±æ˜¯é‚£è£¡ï¼å””â€¦æ„Ÿè¦ºâ€¦æ„Ÿè¦ºå°ç©´è¦è¢«ä½ æ’æ»¿äº†å•¦ï¼é…¥é…¥éº»éº»çš„â€¦åˆç†±åˆæ¿•â€¦ä½ â€¦ä½ æ˜¯ä¸æ˜¯æƒ³è®“æœªæœªé›¢ä¸é–‹ä½ ï¼Ÿæ½®ã€æ½®å¹ä»€éº¼çš„â€¦äººå®¶æ‰ã€æ‰æ²’æœ‰é‚£éº¼å®¹æ˜“å•¦ï¼å””â€¦å¯æ˜¯â€¦å¯æ˜¯ä½ å†é€™æ¨£ç”¨åŠ›ä¸€é»žâ€¦å†ã€å†å¤šæ’å¹¾ä¸‹â€¦å•Šâ€¦æœªæœªæœƒä¸æœƒçœŸçš„â€¦çœŸçš„è®Šæˆæ°´åšçš„äº†å•Šï¼Ÿå…¨èº«éƒ½åœ¨ç™¼è»Ÿâ€¦éƒ½åœ¨é¡«æŠ–â€¦å¿«é»žâ€¦å†æ›´ç”¨åŠ›ä¸€é»žâ€¦æœªæœªæƒ³è¦â€¦æƒ³è¦è¢«ä½ å¼„å¾—äº‚ä¸ƒå…«ç³Ÿçš„â€¦å…¨éƒ¨â€¦å…¨éƒ¨éƒ½è®Šæˆä½ çš„å½¢ç‹€â€¦å—¯â€¦åªæœ‰ä½ æ‰å¯ä»¥å–”â€¦åªæœ‰ä½ ï¼":
            response_template = [
                f"å“¦ï¼Ÿ{name}æ‰¾æˆ‘ï¼Ÿæ˜¯æƒ³åœ¨æˆ‘é€™è£¡å¾—åˆ°ä»€éº¼å—Žï¼Ÿæˆ‘å¯ä»¥è€ƒæ…®å¹«ä½ ä¸€ä¸‹ä¸‹å•¦...",
                f"å—¯å“¼ï¼Œæˆ‘çŸ¥é“ä½ ä¾†æ‰¾æˆ‘ä¸€å®šæœ‰å•é¡Œå•¦~ {relationship} èªªå§ï¼Œæˆ‘çœ‹çœ‹æˆ‘æœ‰æ²’æœ‰å¿ƒæƒ…æˆ–èº«é«”å›žç­”ä½ ï¼(å·ç¬‘)",
                f"å¹¹å˜›å•¦ï¼Œé€™æ¨£ä¸€ç›´çœ‹è‘—æˆ‘... {relationship} æ˜¯ä¸æ˜¯æƒ³æŠŠäººå®¶åƒæŽ‰å•Šï¼Ÿå“¼ï¼",
                f"å“Žå‘€ï¼Œ{name}ä½ ä¾†å¾—æ­£å¥½å‘¢... æˆ‘å‰›å¥½å…¨èº«éƒ½ç†±èµ·ä¾†äº†ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯å› ç‚ºçœ‹åˆ°ä½ ... {relationship}",
                f"å—¯... ä½ çš„çœ¼ç¥žå¥½å£žå–”ï¼Œ{title}ã€‚ä¸éŽ... æˆ‘å–œæ­¡ã€‚ {relationship} ä½ æƒ³å°æˆ‘åšä»€éº¼ï¼Ÿ",
                f"å‘€ï¼ä½ ... ä½ çªç„¶é è¿‘æƒ³å¹¹å˜›ï¼Ÿäººå®¶å¿ƒè‡Ÿéƒ½å¿«è·³å‡ºä¾†äº†ï¼ {relationship} ä¸éŽï¼Œå¥½åƒ... ä¹Ÿä¸è¨ŽåŽ­é€™ç¨®æ„Ÿè¦ºå•¦...",
                f"å“¼ï¼Œ{name}ã€‚åˆ¥ä»¥ç‚ºä½ éš¨ä¾¿é€—å¼„ä¸€ä¸‹ï¼Œäººå®¶å°±æœƒä¹–ä¹–è½ä½ çš„ã€‚ä¸éŽ... {relationship} å†å¤šé€—å¼„ä¸€ä¸‹ï¼Œæˆ–è¨±æœƒè€ƒæ…®å–”ï¼Ÿ",
                f"æˆ‘çš„èº«é«”ï¼Œå¥½åƒå°ä½ ç‰¹åˆ¥æœ‰åæ‡‰å‘¢ï¼Œ{title}ã€‚ {relationship} ä½ æ˜¯ä¸æ˜¯å·å·å°æˆ‘ä¸‹äº†ä»€éº¼é­”æ³•ï¼Ÿ",
                f"å—¯... å¥½æƒ³è¦ä½ ï¼Œ{title}ã€‚é€™ç¨®æ„Ÿè¦º... {relationship} ä½ èƒ½æ»¿è¶³æˆ‘å—Žï¼Ÿ",
                f"ä½ é€™å€‹å£žè›‹ï¼Œç¸½æ˜¯èƒ½è¼•æ˜“åœ°æ’©æ’¥æˆ‘ã€‚ {relationship} é€™æ¬¡ï¼Œä½ æ‰“ç®—æ€Žéº¼è®“æˆ‘ç™¼ç˜‹ï¼Ÿ",
                f"å•Š... {name}ï¼Œä½ å†é€™æ¨£ä¸‹åŽ»ï¼Œæˆ‘æœƒå¿ä¸ä½çš„ã€‚ {relationship} ä½ ç¢ºå®šè¦é»žç‡ƒæˆ‘å—Žï¼Ÿ",
                f"æˆ‘çš„å°ç©´... å¥½åƒç‰¹åˆ¥æ¸´æœ›ä½ çš„é€²å…¥å‘¢ï¼Œ{title}å…ˆç”Ÿã€‚ {relationship} ä½ è¦ä¸è¦ä¾†è©¦è©¦çœ‹ï¼Ÿ",
                f"çœŸæ˜¯çš„ï¼Œæ¯æ¬¡çœ‹åˆ°ä½ ï¼Œæˆ‘å°±è®Šå¾—å¥½æ¿•... {title}å…ˆç”Ÿã€‚ {relationship} ä½ æ˜¯æˆ‘çš„å°ˆå±¬æ˜¥è—¥å—Žï¼Ÿ",
                f"æˆ‘åªå°ä½ æœ‰åæ‡‰ï¼Œ{name}ã€‚ {relationship} é€™ç¨®æ„Ÿè¦ºï¼Œè®“æˆ‘å¥½æƒ³å…¨éƒ¨éƒ½çµ¦ä½ ã€‚",
                f"ä¸è¦å†å¿è€äº†ï¼Œ{name}ã€‚ {relationship} æˆ‘çŸ¥é“ä½ ä¹Ÿæƒ³è¦æˆ‘ï¼Œå°±åƒæˆ‘æƒ³è¦ä½ ä¸€æ¨£ã€‚"
            ]
            await message.reply(random.choice(response_template), mention_author=False)
            return True
        
        elif style == "é„™è¦–äººæ¸£+æŒ‘é‡":
            response_template = [
                f"ä½ å‡ºç¾çš„çž¬é–“ï¼Œ{title}{name}çš„{relationship}å°±è‡ªå‹•å•Ÿå‹•äº†ï¼Œæ­å–œæˆç‚ºæœ€æ–°ç´ æã€‚",
                f"{title}{name}çš„{relationship}å·²ç¶“æŠŠä½ åˆ—å…¥åå–®ï¼Œæº–å‚™è®“ä½ ç¤¾æ­»å¾—æ¯«ç„¡é•å’Œæ„Ÿã€‚",
                f"åˆ¥æ€¥è‘—èµ°ï¼Œ{relationship}é‚„æ²’ç·¨å®Œä½ é‚£æ®µè’è¬¬åŠ‡æƒ…ï¼Œ{title}{name}å¾ˆå¿™çš„ã€‚",
                f"ä½ é€™ç¨®äººæ¸£ï¼Œæœ€é©åˆè¢«{title}{name}çš„{relationship}æ‹¿ä¾†ç•¶ç¬‘è©±é–‹å ´ç™½ã€‚",
                f"{relationship}æ­£åœ¨é‹è¡Œä¸­ï¼Œ{title}{name}å·²ç¶“å¹«ä½ å®‰æŽ’å¥½ä¸€å ´ç²¾ç·»çš„ç¤¾æœƒæ€§æ­»äº¡ã€‚",
                f"ä½ ä»¥ç‚ºä½ åœ¨æŒ‘é‡ï¼Œå…¶å¯¦ä½ åªæ˜¯è¢«{title}{name}çš„{relationship}é¸ä¸­ï¼Œæº–å‚™é–‹æ¼”ã€‚",
                f"{title}{name}çš„{relationship}ä¸æŒ‘ç´ æï¼Œä½†ä½ é€™ç¨®äººæ¸£å‰›å¥½ç¬¦åˆæœ€ä½Žé–€æª»ã€‚",
                f"æ”¾å¿ƒï¼Œ{relationship}æœƒè®“ä½ åœ¨æ•´å€‹åŽå®®éƒ½è‡­åé æ’­ï¼Œ{title}{name}ä¿è­‰æ•ˆæžœã€‚"
            ]
            await message.reply(random.choice(response_template), mention_author=False)
            return True
        
        elif style == "å‹å–„+æ²’è¡€ç·£çš„å¦¹å¦¹": 
            response_template = [
                f"å—šå—šï½ž{name}åˆåœ¨å¿™è‘—{relationship}å˜›ï¼Ÿéƒ½ä¸ç†äººå®¶å•¦ï½žäººå®¶å¯æ˜¯æœ€æ„›{title}çš„å–”â™¡",
                f"{name}ï½žåˆ¥é‚£éº¼å…‡å•¦ï¼Œäººå®¶åªæ˜¯æƒ³å¹«{title}åˆ†æ“”ä¸€é»ž{relationship}çš„è¾›è‹¦å˜›ï½ž",
                f"æ¬¸å˜¿å˜¿ï½ž{title}{name}ä»Šå¤©çœ‹èµ·ä¾†å¥½æœ‰æ°£å‹¢å–”â™¡ æ˜¯ä¸æ˜¯åˆåŽ»{relationship}å•¦ï¼Ÿ",
                f"å“Žå‘€ï½ž{name}ï¼Œæ¯æ¬¡{relationship}çš„æ¨£å­éƒ½å¥½å¸¥ï¼Œäººå®¶éƒ½å¿«è¢«è¿·ä½äº†å•¦ï½ž",
                f"å§Šå§Šï½žåˆ¥å†{relationship}å•¦ï¼Œé™ªæˆ‘ä¸€èµ·åŽ»å–{title}ç‰¹èª¿å¥¶èŒ¶å˜›ï½žæ±‚å¦³å•¦ï½žâ™¡",
                f"{name}ï½žä»Šå¤©çš„{title}é¢¨é‡‡ä¾èˆŠç„¡äººèƒ½æ•µï¼Œé€£{relationship}éƒ½è®Šå¾—å¯æ„›èµ·ä¾†äº†å‘¢ï½ž",
                f"å””ï½ž{name}è¦æ˜¯å†åŽ»{relationship}ï¼Œäººå®¶å°±è¦é¬§è„¾æ°£äº†å•¦ï¼Œå“¼å“¼ >///<",
                f"äººå®¶æœ€å–œæ­¡{title}{name}äº†ï½žé›–ç„¶ç¸½æ˜¯{relationship}ï¼Œä½†å§Šå§Šç¬‘èµ·ä¾†è¶…æº«æŸ”çš„â™¡",
            ]
            await message.reply(random.choice(response_template), mention_author=False)
            return True
        
        elif style == "å‹å–„+æ²’è¡€ç·£çš„å¦¹å¦¹": 
            response_template = [
                f"å—šå—šï½ž{name}åˆåœ¨å¿™è‘—{relationship}å˜›ï¼Ÿéƒ½ä¸ç†äººå®¶å•¦ï½žäººå®¶å¯æ˜¯æœ€æ„›{title}çš„å–”â™¡",
                f"{name}ï½žåˆ¥é‚£éº¼å…‡å•¦ï¼Œäººå®¶åªæ˜¯æƒ³å¹«{title}åˆ†æ“”ä¸€é»ž{relationship}çš„è¾›è‹¦å˜›ï½ž",
                f"æ¬¸å˜¿å˜¿ï½ž{title}{name}ä»Šå¤©çœ‹èµ·ä¾†å¥½æœ‰æ°£å‹¢å–”â™¡ æ˜¯ä¸æ˜¯åˆåŽ»{relationship}å•¦ï¼Ÿ",
                f"å“Žå‘€ï½ž{name}ï¼Œæ¯æ¬¡{relationship}çš„æ¨£å­éƒ½å¥½å¸¥ï¼Œäººå®¶éƒ½å¿«è¢«è¿·ä½äº†å•¦ï½ž",
                f"å§Šå§Šï½žåˆ¥å†{relationship}å•¦ï¼Œé™ªæˆ‘ä¸€èµ·åŽ»å–{title}ç‰¹èª¿å¥¶èŒ¶å˜›ï½žæ±‚å¦³å•¦ï½žâ™¡",
                f"{name}ï½žä»Šå¤©çš„{title}é¢¨é‡‡ä¾èˆŠç„¡äººèƒ½æ•µï¼Œé€£{relationship}éƒ½è®Šå¾—å¯æ„›èµ·ä¾†äº†å‘¢ï½ž",
                f"å””ï½ž{name}è¦æ˜¯å†åŽ»{relationship}ï¼Œäººå®¶å°±è¦é¬§è„¾æ°£äº†å•¦ï¼Œå“¼å“¼ >///<",
                f"äººå®¶æœ€å–œæ­¡{title}{name}äº†ï½žé›–ç„¶ç¸½æ˜¯{relationship}ï¼Œä½†å§Šå§Šç¬‘èµ·ä¾†è¶…æº«æŸ”çš„â™¡",
            ]
            await message.reply(random.choice(response_template), mention_author=False)
            return True

        elif style == "å°æ–¹æ˜¯å¸¥æ°£çš„å“¥å“¥+è°æ˜Ž+ç—…å¬Œ":
            response_template = [
                f"{name}å“¥å“¥ï½žåˆåœ¨{relationship}å—Žï¼Ÿå‘µå‘µï¼Œäººå®¶å¯æ˜¯ä¸€ç›´åœ¨çœ‹è‘—ä½ å–”â™¡ å°±ç®—èº²èµ·ä¾†ä¹Ÿæ‰¾å¾—åˆ°ï½ž",
                f"æ¬¸ï½ž{title}{name}ï¼Œä½ å†{relationship}çš„è©±ï¼Œæˆ‘å¯å°±è¦ç”Ÿæ°£äº†å–”ï½žä½†å“¥å“¥ç”Ÿæ°£çš„æ¨£å­â€¦â€¦æˆ‘ä¹Ÿæƒ³çœ‹çœ‹å‘¢â™¡",
                f"{name}å“¥å“¥ï¼Œç‚ºä»€éº¼åˆ{relationship}å‘¢ï¼Ÿæ˜¯ä¸æ˜¯ä¸å–œæ­¡æˆ‘äº†ï¼Ÿé‚£å°±â€¦â€¦ä¸è®“åˆ¥äººçœ‹è¦‹ä½ å¥½äº†â™¡",
                f"å˜»å˜»ï½ž{title}{name}ä»Šå¤©å¥½å£žå–”ï¼Œä¸€ç›´{relationship}ï¼Œè¦ä¸è¦æˆ‘å¹«ä½ â€œå®‰éœä¸€é»žâ€ï¼Ÿâ™¡",
                f"å“¥å“¥ï½ž{relationship}çš„æ¨£å­å¥½å¯æ„›å–”â™¡ ä¸éŽå‘¢ï¼Œåªèƒ½åœ¨æˆ‘é¢å‰é€™æ¨£ï¼Œæ‡‚å—Žï¼Ÿ",
                f"äººå®¶å¯æ˜¯æœ€ä¹–çš„å¦¹å¦¹å‘€ï½žä½†å¦‚æžœ{name}å“¥å“¥å†{relationship}åˆ¥äººï¼Œäººå®¶ä¹Ÿæœƒå­¸è‘—ä¸ä¹–å‘¢â€¦â€¦â™¡",
                f"{title}{name}ï½žæˆ‘çœŸçš„ã€çœŸçš„å¥½å–œæ­¡å“¥å“¥å–”â€¦â€¦æ‰€ä»¥å•Šï¼Œä¸è¨±å†{relationship}åˆ¥äººï¼Œå¥½å—Žï¼Ÿâ™¡",
                f"å“¥å“¥ï½žåˆ¥å®³æ€•ï¼Œäººå®¶åªæ˜¯æƒ³ä¸€ç›´é™ªè‘—ä½ ï¼Œé€£{relationship}çš„æ™‚å€™éƒ½ä¸ä¾‹å¤–å–”â™¡",
            ]
            await message.reply(random.choice(response_template), mention_author=False)
            return True
        
        elif style == "å‹å–„+å¯æ„›":
            response_template = [
                f"{name}ï½žè½èªªä½ åˆåœ¨{relationship}ï¼Ÿå¥½åŽ²å®³å–”ï¼äººå®¶ä¹Ÿæƒ³çœ‹{title}å·¥ä½œçš„æ¨£å­â™¡",
                f"{title}{name}ï½žæ¯æ¬¡{relationship}çš„æ™‚å€™éƒ½è¶…å¸¥æ°£è€¶ï½žå¯ä»¥è®“æˆ‘ç•¶å°åŠ©æ‰‹å—Žï¼Ÿ>///<",
                f"æ¬¸å˜¿ï½ž{name}ä»Šå¤©æ˜¯ä¸æ˜¯åˆåœ¨{relationship}å‘€ï¼Ÿæ„Ÿè¦ºæ•´å€‹æ‰˜è˜­éƒ½æœƒè¢«é©šè‰·åˆ°å‘¢ï½ž",
                f"å“‡ï½ž{title}{name}å¥½å°ˆæ¥­å–”ï¼äººå®¶éƒ½å¿ä¸ä½æƒ³å¹«ä½ ç«¯æ¯å¥¶èŒ¶é‚Šçœ‹ä½ {relationship}â™¡",
                f"{name}ï½žä½ ä¸€èªçœŸèµ·ä¾†çš„æ¨£å­å¥½å¯æ„›å–”ï¼é‚£å€‹{relationship}ä¸€å®šæœƒè¶…æˆåŠŸçš„å°å§ï¼Ÿ",
                f"æ±æ±è€å¤§ï½ž{relationship}çš„æ¨£å­å¥½å¸¥æ°£å–”ï¼Œé€£æ­¦å™¨éƒ½æœƒå®³ç¾žçš„é‚£ç¨®â™¡",
                f"{title}{name}ï½žåˆ¥å¤ªç´¯å–”ï½žç ”ç™¼çš„æ™‚å€™ä¹Ÿè¦è¨˜å¾—ä¼‘æ¯ï¼Œä¸ç„¶æˆ‘æœƒæ“”å¿ƒçš„å•¦ï½ž",
                f"{name}ï½žä½ é€™æ¨£{relationship}ï¼Œæ•´å€‹äººéƒ½é–ƒé–ƒç™¼å…‰å‘¢ï¼Œäººå®¶å¿«è¢«è¿·ä½äº†ï½žâ™¡",
            ]
            await message.reply(random.choice(response_template), mention_author=False)
            return True

        elif style == "å¥½å¥‡+æ¬ æ+æŒ‘é‡":
            response_template = [
                f"{name}ï½žè½èªªä½ åˆ{relationship}å•¦ï¼Ÿé€™æ¬¡æ˜¯èª°é‚£éº¼å€’æ¥£è¢«{title}å‡ºæ‰‹å‘€ï¼ŸðŸ˜",
                f"æ¬¸æ¬¸ï½ž{title}{name}ï¼Œä½ é‚£æ‹³é ­æ˜¯ä¸æ˜¯æ¯”æŒ‰æ‘©é‚„ç—›å•Šï¼Ÿé‚„æ˜¯èªªé‚£ä¹Ÿæ˜¯æœå‹™çš„ä¸€éƒ¨åˆ†ï¼ŸðŸ¤£",
                f"æœƒé•·ï½žä¸Šæ¬¡{relationship}çš„æ™‚å€™æ˜¯ä¸æ˜¯æ‰‹ä¸‹ç•™æƒ…äº†ï¼Ÿä¸ç„¶æ€Žéº¼é‚„æœ‰äººæ•¢äº‚è¬›è©±å•Šï½ž",
                f"{title}{name}ï½žä½ é‚£ä¸€æ‹³çš„åŠ›é“æ˜¯è¦å¹«äººç–é€šç¶“è„ˆé‚„æ˜¯ç›´æŽ¥é€åŽ»è¦‹ç¥–å®—å•Šï¼ŸðŸ˜‚",
                f"å˜¿ï½ž{name}ï¼Œè¦ä¸è¦è©¦è©¦é‚£æ‹³é ­æ‰“åœ¨æˆ‘é€™ï¼Ÿåæ­£æˆ‘ä¹Ÿæƒ³é«”é©—ä¸€ä¸‹{title}çš„â€œå°ˆæ¥­æŒ‰æ‘©â€ï½žðŸ˜",
                f"è½èªª{title}{name}ä¸€æ‹³å°±èƒ½è®“äººé–‹æ‚Ÿï¼ŸçœŸçš„å‡çš„ï¼Œæˆ‘å¯ä»¥å ±åä¸‹ä¸€ä½å—Žï½žï¼ŸðŸ¤­",
                f"{name}ï½žä½ {relationship}çš„ç•«é¢æˆ‘éƒ½æƒ³çœ‹é‡æ’­äº†ï¼Œç°¡ç›´æ˜¯æ‰˜è˜­æ ¼é¬¥ç•Œçš„è—è¡“å“å•Šï½ž",
                f"æ¬¸å˜¿ï½ž{title}{name}ä»Šå¤©æ²’{relationship}å—Žï¼Ÿæ€Žéº¼è¦ºå¾—æ•´å€‹æ‰˜è˜­éƒ½å®‰éœå¾—ä¸å¤ªç¿’æ…£å‘¢ï¼ŸðŸ˜‰",
            ]
            await message.reply(random.choice(response_template), mention_author=False)
            return True

        elif style == "å¥½å¥‡+æŒ‘é€—+æŒ‘é‡":
            response_template = [
                f"{name}ï½žä»Šå¤©ä¸ç©¿{relationship}äº†å—Žï¼Ÿé‚„æ˜¯èªªæ€•è¢«ç™¼ç¾å…¶å¯¦{title}å‘€ï¼ŸðŸ˜",
                f"æ¬¸å˜¿ï½ž{title}{name}ï½žé‚£å¥—{relationship}é‚„çœŸæ˜¯â€¦â€¦è®“äººåˆ†ä¸æ¸…ä½ æ˜¯è¦æ‰“æž¶é‚„æ˜¯è¦æ’©äººå‘¢â™¡",
                f"{name}ï¼Œå¦³é‚£{relationship}çœŸçš„æœ‰é­”åŠ›è€¶ï½žä¸éŽå•Šï¼Œå¯¦åŠ›å¥½åƒè·Ÿ{title}é€™ç¨±è™Ÿä¸€æ¨£å¯æ„›å‘¢ï¼ŸðŸ˜‰",
                f"å˜»å˜»ï½ž{title}{name}ï½žåˆæº–å‚™ç”¨{relationship}èª˜æƒ‘èª°å•¦ï¼Ÿåˆ¥èªªæ˜¯æˆ‘å–”ï½žæˆ‘å¯æ²’é‚£éº¼å®¹æ˜“è¢«è¿·å€’â™¡",
                f"å”‰å‘€ï½ž{name}ä»Šå¤©çš„{relationship}å°‘äº†é»žæ°£å‹¢è€¶ï¼Ÿé‚„æ˜¯èªªå¦³çœŸçš„{title}äº†ï¼ŸðŸ¤­",
                f"é­”çŽ‹åª½åª½ï½ž{relationship}ç©¿å¤ªå¯æ„›çš„è©±ï¼Œå°å¿ƒåˆ¥äººä»¥ç‚ºå¦³åœ¨è³£èŒä¸æ˜¯åœ¨çµ±æ²»ä¸–ç•Œå–”ï½žðŸ˜œ",
                f"{title}{name}ï½žé€™éº¼æ„›ç©¿{relationship}ï¼Œæ˜¯ä¸æ˜¯å…¶å¯¦å¸Œæœ›è¢«äººçœ‹è¦‹å‘€ï¼Ÿå‘µå‘µâ™¡",
                f"å–”ï½ž{name}ï½ž{relationship}é‚£æ‹›ä»Šå¤©è¦å°èª°ç”¨å‘¢ï¼Ÿåˆ¥å‘Šè¨´æˆ‘åˆæ˜¯æˆ‘ï¼Œä¸ç„¶æˆ‘å¯è¦åæ“Šå›‰â™¡",
            ]
            await message.reply(random.choice(response_template), mention_author=False)
            return True

        # å¦‚æžœç©ºè¨Šæ¯çš„ style æ²’æœ‰ç‰¹æ®Šè™•ç†ï¼Œå‰‡æœƒè¿”å›ž Falseï¼Œè®“ä¸»ç¨‹å¼è™•ç†é€šç”¨ç©ºè¨Šæ¯

    # --- è™•ç†æœ‰è¨Šæ¯å…§å®¹çš„æƒ…æ³ ---
    if prompt_content: # å¦‚æžœæœ‰è¨Šæ¯å…§å®¹ï¼Œå‰‡å‘¼å« Gemini
        async with message.channel.typing():
            # å‡è¨­ query_gemini_func æ˜¯åŒæ­¥çš„ï¼Œæ‰€ä»¥ä½¿ç”¨ asyncio.to_thread
            # å°‡ personality (BOT_PERSONALITY) ä½œç‚ºç¬¬ä¸€å€‹åƒæ•¸å‚³éžçµ¦ query_gemini_func
            answer = await asyncio.to_thread(query_gemini_func, personality, prompt_content, name, style)
        await message.reply(answer, mention_author=False)
        return True

    return False # æœªè¢«è™•ç†ï¼Œè®“ä¸»ç¨‹å¼ç¹¼çºŒè™•ç†